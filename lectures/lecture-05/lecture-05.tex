\input{../preamble.tex}

\lecturenumber{5}
\title{Process Management}
\version{1.0.0}
\author{Jon Eyolfson}
\date{September 19, 2022}

\begin{document}
  \begin{frame}[plain, noframenumbering]
    \titlepage
  \end{frame}

  \begin{frame}
    \frametitle{Maintaining the Parent/Child Relationship}

    Previously, we made sure that our parent exited last (by using \texttt{sleep})

    \vspace{2em}

    What happens if the parent process exits first, and no longer exists?
  \end{frame}

  \begin{frame}[fragile]
    \frametitle{\texttt{orphan-example.c} The Parent Exits Before the Child, \texttt{init} Cleans Up}

    \begin{lstlisting}
int main(int argc, char *argv[]) {
  pid_t pid = fork();
  if (pid == -1) {
    int err = errno;
    perror("fork failed");
    return err;
  }
  if (pid == 0) {
    printf("Child parent pid: %d\n", getppid());
    sleep(2);
    printf("Child parent pid (after sleep): %d\n", getppid());
  }
  else {
    sleep(1);
  }
  return 0;
}

    \end{lstlisting}
  \end{frame}

  \begin{frame}[fragile]
    \frametitle{\texttt{zombie-example.c} The Parent Monitors the Child To Check Its State}

    \begin{lstlisting}
  pid_t pid = fork();
  // Error checking
  if (pid == 0) {
    sleep(2);
  }
  else {
    // Parent process
    int ret;
    sleep(1);
    printf("Child process state: ");
    ret = print_state(pid);
    if (ret < 0) { return errno; }
    sleep(2);
    printf("Child process state: ");
    ret = print_state(pid);
    if (ret < 0) { return errno; }
  }
    \end{lstlisting}
  \end{frame}

  \begin{frame}
    \frametitle{You Need to Call \texttt{wait} on Child Processes}

    \texttt{wait} as the following API:
    \begin{itemize}
      \item \texttt{status}: Address to store the wait status of the process
      \item Returns the process ID of child process

            \hspace{2em} -1: on failure

            \hspace{2em} 0: for no blocking calls with no child changes

            \hspace{2em} >0: the child with a change
    \end{itemize}

    \vspace{2em}

    The wait status contains a bunch of information, including the exit code

    \hspace{2em} Use \texttt{man wait} to find all the macros to query wait status

    \hspace{4em} You can use \texttt{waitpid} to wait on a specific child process
  \end{frame}

  \begin{frame}[fragile]
    \frametitle{\texttt{wait-example.c} Blocks Until The Child Process Exists, and Cleans Up}

    \begin{lstlisting}
int main(int argc, char *argv[]) {
  pid_t pid = fork();
  if (pid == -1) {
    return errno;
  }
  if (pid == 0) {
    sleep(2);
  }
  else {
    printf("Calling wait\n");
    int wstatus;
    pid_t wait_pid = wait(&wstatus);
    if (WIFEXITED(wstatus)) {
      printf("Wait returned for an exited process! pid: %d, status: %d\n",
             wait_pid, WEXITSTATUS(wstatus));
    }
  }
  return 0;
}
    \end{lstlisting}
  \end{frame}

  \begin{frame}
    \frametitle{You're Responsible for Managing Processes}

    The operating system maintains a strict parent/child relationship
    
    \vspace{2em}
    
    You should be able to identify (and prevent) the following:
    \begin{itemize}
      \item Zombie processes
      \item Orphan processes
    \end{itemize}
  \end{frame}
\end{document}
